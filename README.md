This is a series of Matlab codes for my own reference. The codes is written by Stefan Nixon. 

mainSID.m是主代码，把原始的 LIF 灰度图像，变成一个“已经校正了激光、不均匀照明、条纹噪声和光学几何畸变的、可以当作相对浓度场来用的标量场”。
mainSID.m is the main code. It converts the raw LIF grayscale images into a “scalar field that has already been corrected for laser intensity, non-uniform illumination, stripe noise, and optical/geometric distortion, and can be treated as a relative concentration field”.

整个流程分成三块儿：
The whole workflow is divided into three parts:
1. 标定与坐标变换：把相机坐标映射到一个“光线竖直、光路平行”的坐标系，方便在物理意义上沿激光传播方向做运算。
   Calibration and coordinate transformation: map the camera coordinates into a coordinate system where the light rays are vertical and the optical paths are parallel, so that operations along the laser propagation direction have a clear physical meaning.
2. 背景与激光片的确定：用 4 张背景图（fIn2代表无染料有灯光；fIn3代表无染料无灯光；fIn4代表有染料有灯光；fIn5代表有染料无灯光）来估计：相机自身噪声；激光片空间分布；染料均匀时的响应（用于标度）。
   Determination of background and laser sheet: use 4 background images (fIn2: no dye, laser on; fIn3: no dye, laser off; fIn4: dye present, laser on; fIn5: dye present, laser off) to estimate: the camera’s own noise; the spatial distribution of the laser sheet; and the response when the dye is uniform (used for scaling).
3. 对每一帧实验 LIF 图像做：校正照明不均匀；选择性去条纹；考虑激光沿程衰减和染料的吸收；归一化到一个“0–1”的相对浓度。（使用correct_Plif_MI_new这个函数，包含使用小波变换和FFT）
   For each experimental LIF image frame: correct non-uniform illumination; optionally remove stripes; take into account laser attenuation along the path and dye absorption; and normalise to a “0–1” relative concentration. (This uses the function correct_Plif_MI_new, which includes wavelet transform and FFT.)
Note：想要了解更多有关小波转换的信息可以看munch et al. 2009: "Stripe and ring artifact removal with combined wavelet — Fourier filtering"
Note: For more information on wavelet transforms, see Munch et al. 2009: "Stripe and ring artifact removal with combined wavelet — Fourier filtering".

其余函数有各自的功能：
The remaining functions each have their own roles:
1. dfi2mat：把 DigiFlow的图片(.dfi)文件变成 MATLAB 能算的图像，更具体地说转换成了一个Matlab结构体Struct。可以随时调取图像数据、时间、空间标度、标定信息等。
   dfi2mat: converts DigiFlow image (.dfi) files into images that MATLAB can process; more specifically, it converts them into a Matlab struct. You can then access image data, time, spatial scaling, calibration information, etc. at any time.
2. mapTo：用标定结果把图像转换到目标坐标系，含义：根据 x_map_file 和 y_map_file，把原始图像重采样到“光线平行坐标系”。
   mapTo: uses the calibration results to transform the image into the target coordinate system. Meaning: based on x_map_file and y_map_file, it resamples the original image into the “parallel-ray coordinate system”.
3. RemoveStripesVertical：竖直条纹去除滤波，含义：用“小波分解 + 频域滤波”的方法，把图像中的竖直条纹 artefacts 去掉。小波可以把图像分解到不同的空间尺度（大结构 vs 小结构）；在每个尺度里再做 FFT，可以识别“特定方向的周期性条纹”。
   RemoveStripesVertical: vertical stripe removal filter. Meaning: uses the method of “wavelet decomposition + frequency-domain filtering” to remove vertical stripe artefacts in the image. Wavelets can decompose the image into different spatial scales (large structures vs small structures); at each scale, an FFT is applied to identify “periodic stripes in specific directions”.
4. df_dfm_info:给定一个DigiFlow 生成的 .dfm 电影文件，读取文件头和帧目录，返回一个结构体 p，里面包含：这段视频的基本信息（谁做的、什么时候做的、多大、多长）、每一帧在文件中的位置、以及图像的大小等。
   df_dfm_info: given a .dfm movie file generated by DigiFlow, it reads the file header and the frame table, and returns a struct p containing: basic information about the movie (who made it, when it was made, its size, its duration), the position of each frame in the file, and the image size, etc.
5. 这个 df_dfm_read 可以理解成：把 .dfm 电影文件里的若干帧，真正读成 MATLAB 里的图像数组的函数。
   df_dfm_read can be understood as: a function that actually reads several frames from a .dfm movie file into MATLAB as image arrays.
6. dfiRegion：按照 DigiFlow 里选的 extract_region，把 dfi 图像在 MATLAB 里裁出来，而且把“底部为原点”的坐标系换成 MATLAB 的“左上角为原点”。因为digiFlow和matlab的图片坐标系不一致。
   dfiRegion: according to the extract_region selected in DigiFlow, it crops the dfi image in MATLAB, and also converts the coordinate system from “bottom as origin” to MATLAB’s “top-left as origin”, because DigiFlow and MATLAB use different image coordinate conventions.
7. dfiPlot：把 dfi2mat 读进来的 dfi 结构体，自动画成图：先画标量场（image），再叠加矢量场（vectors）。
   dfiPlot: takes the dfi struct read in by dfi2mat and automatically plots it: first plotting the scalar field (image), then overlaying the vector field (vectors).
8. fillZeros：把矩阵里为 0 的点，用它上下左右非零邻居的平均值来“填补”，相当于做一个很简单的插值 / 填洞操作。
    fillZeros: fills the entries in a matrix that are 0 with the average of their non-zero neighbours above, below, left, and right, which is essentially a very simple interpolation / hole-filling operation.
9. FiltWindow：对整张图像，用一个 window_size × window_size 的小框在上面滑过去，每次在这个框里做一点处理，然后把结果累加起来，最后平均一下，得到一张被“抹平/降噪”后的图片。
    FiltWindow: over the whole image, a small window of size window_size × window_size is slid across; each time some processing is done within this window, the results are accumulated, and finally averaged, giving an image that has been “smoothed / denoised”.
10. text2mat：把一个存成 .txt 的数字表格（比如坐标映射数组）读进来，按指定的行列数还原成 MATLAB 里的矩阵。
    text2mat: reads a numeric table stored as a .txt file (for example, a coordinate mapping array) and reconstructs it as a MATLAB matrix according to the specified number of rows and columns.

做实验需要拍摄的：
Images that need to be taken for the experiment:
1. 4个背景图：fIn2代表无染料有灯光；fIn3代表无染料无灯光；fIn4代表有染料有灯光；fIn5代表有染料无灯光
   Four background images: fIn2 represents no dye with light on; fIn3 represents no dye with light off; fIn4 represents dye present with light on; fIn5 represents dye present with light off.
2. 不对齐的点格：用于做
3. Streaks：用于生成 x_map_file 和 y_map_file，把原始图像重采样到“光线平行坐标系”。
   Streaks: used to generate x_map_file and y_map_file, and to resample the original images into the “parallel-ray coordinate system”.
Note：生成坐标系的代码在"C:\sys\digiflow\Bin64\Macros\Wizards\Wizard_CoordSystem.dfc"
Note: the code for generating the coordinate system is in "C:\sys\digiflow\Bin64\Macros\Wizards\Wizard_CoordSystem.dfc".
